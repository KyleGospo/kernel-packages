name: Build (Nobara)

on:
    workflow_dispatch:
        inputs:
            ogc_version:
                description: 'OGC kernel version (e.g., v6.18.7-ogc2)'
                required: false
                default: 'v6.18.7-ogc2'
            repo_owner:
                description: 'Repository owner for linux source'
                required: false
                default: 'OpenGamingCollective'
    push:

jobs:
    build-rpm:
        runs-on: ubuntu-latest

        container:
            image: fedora:latest
            volumes:
                - /usr:/usr-host
                - /opt:/opt-host
            options: --privileged

        steps:
            - name: Maximize build space
              run: |
                  df -h
                  rm -rf /usr-host/share/dotnet
                  rm -rf /usr-host/share/swift
                  rm -rf /usr-host/share/java
                  rm -rf /usr-host/local/lib/android
                  rm -rf /opt-host/ghc
                  rm -rf /opt-host/hostedtoolcache
                  rm -rf /opt-host/az
                  df -h
            - name: Checkout sources
              uses: actions/checkout@v4

            - name: Dependencies
              run: |
                  dnf -y builddep nobara/kernel.spec
            - name: build
              run: |
                  TOPDIR="$(pwd)/rpmbuild"

                  mkdir -p "$TOPDIR"/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
                  cp nobara/* $TOPDIR/SOURCES
                  
                  # Set environment variables for the spec file
                  export OGC_VERSION="${{ github.event.inputs.ogc_version || 'v6.18.7-ogc2' }}"
                  export REPO_OWNER="${{ github.event.inputs.repo_owner || github.repository_owner }}"

                  rpmbuild --define "_topdir $TOPDIR" --define "ogc_version $OGC_VERSION" --define "repo_owner $REPO_OWNER" -ba ./nobara/kernel.spec
