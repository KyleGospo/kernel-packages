name: Build (arch)

on:
    workflow_dispatch:
        inputs:
            ogc_version:
                description: 'Enter a released OGC kernel patch version in the format <kernel-version>-ogc<rev>'
                required: true

jobs:
    build-arch:
        runs-on: ubuntu-latest

        container:
            image: docker.io/archlinux:base-devel
            volumes:
                - /usr:/usr-host
                - /opt:/opt-host
            options: --privileged

        steps:
            - name: Maximize build space
              run: |
                  df -h
                  rm -rf /usr-host/share/dotnet
                  rm -rf /usr-host/share/swift
                  rm -rf /usr-host/share/java
                  rm -rf /usr-host/local/lib/android
                  rm -rf /opt-host/ghc
                  rm -rf /opt-host/hostedtoolcache
                  rm -rf /opt-host/az
                  df -h
            - name: Checkout sources
              uses: actions/checkout@v4

            - name: Create build user
              run: |
                  useradd -m build
                  mkdir -p /home/build/linux
                  cp -vR * /home/build/linux
                  chown -vR build /home/build/linux

            - name: Set up pacman keyring
              run: |
                  pacman-key --init
                  pacman-key --populate archlinux
                  mkdir -p /etc/gnupg && echo "auto-key-retrieve" >> /etc/gnupg/gpg.conf

            - name: Install dependencies
              run: |
                  pacman -Syu --noconfirm bc cpio gettext libelf pahole perl python rust rust-bindgen rust-src tar xz graphviz imagemagick python-sphinx python-yaml texlive-latexextra

            - name: Build linux package
              id: build-kernel-package
              shell: bash
              run: |
                  # Set environment variables for PKGBUILD
                  export OGC_VERSION="${{ github.event.inputs.ogc_version }}"
                  export REPO_OWNER="${{ github.repository_owner }}"

                  su build bash -c "cd /home/build/linux/arch && OGC_VERSION='$OGC_VERSION' REPO_OWNER='$REPO_OWNER' MAKEFLAGS=-j$(nproc) makepkg --skippgpcheck"
                  . /home/build/linux/arch/PKGBUILD
                  full_version=${pkgver}-${pkgrel}
                  echo "full_version=$full_version" >> "$GITHUB_OUTPUT"
