name: Build (ubuntu)

on:
    workflow_dispatch:
        inputs:
            ogc_version:
                description: 'OGC kernel version (e.g., v6.18.7-ogc2)'
                required: false
                default: 'v6.18.7-ogc2'
            repo_owner:
                description: 'Repository owner for linux source'
                required: false
                default: 'OpenGamingCollective'
    push:

jobs:
    build-deb:
        runs-on: ubuntu-latest

        container:
            image: ubuntu:latest
            volumes:
                - /usr:/usr-host
                - /opt:/opt-host
            options: --privileged

        steps:
            - name: Maximize build space
              run: |
                  df -h
                  rm -rf /usr-host/share/dotnet
                  rm -rf /usr-host/share/swift
                  rm -rf /usr-host/share/java
                  rm -rf /usr-host/local/lib/android
                  rm -rf /opt-host/ghc
                  rm -rf /opt-host/hostedtoolcache
                  rm -rf /opt-host/az
                  df -h
            - name: Checkout sources
              uses: actions/checkout@v4

            - name: Dependencies
              run: |
                  export DEBIAN_FRONTEND=noninteractive
                  apt-get update -y
                  apt-get install -y build-essential devscripts debhelper dh-python asciidoc-base bc bison cpio dwarves flex kmod libdw-dev libiberty-dev libnuma-dev  libslang2-dev lz4 rsync wget xmlto git
                  apt-get install -y libunwind-dev libpfm4-dev coccinelle openjdk-17-jdk libcapstone-dev libbabeltrace-dev systemtap-sdt-dev libzstd-dev dwarves zstd libbfd-dev libperl-dev libssl-dev
            - name: Get sources
              run: |
                  # Use inputs if available (workflow_dispatch), otherwise use defaults
                  OGC_VERSION="${{ github.event.inputs.ogc_version || 'v6.18.7-ogc2' }}"
                  REPO_OWNER="${{ github.event.inputs.repo_owner || github.repository_owner }}"
                  
                  # Extract kernel version from OGC version (e.g., v6.18.7-ogc2 -> 6.18.7)
                  KERNEL_VERSION=$(echo "$OGC_VERSION" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+)-.*/\1/')
                  
                  wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${KERNEL_VERSION}.tar.xz
                  wget https://github.com/${REPO_OWNER}/linux/releases/download/${OGC_VERSION}/monolithic.patch
                  tar -xf linux-${KERNEL_VERSION}.tar.xz
                  cd linux-${KERNEL_VERSION}
                  cp ../config .config
                  patch -Np1 < "../monolithic.patch"
            - name: Build
              run: |
                  # Use inputs if available (workflow_dispatch), otherwise use defaults
                  OGC_VERSION="${{ github.event.inputs.ogc_version || 'v6.18.7-ogc2' }}"
                  
                  # Extract kernel version from OGC version (e.g., v6.18.7-ogc2 -> 6.18.7)
                  KERNEL_VERSION=$(echo "$OGC_VERSION" | sed -E 's/^v([0-9]+\.[0-9]+\.[0-9]+)-.*/\1/')
                  
                  cd linux-${KERNEL_VERSION}
                  make olddefconfig
                  fakeroot make -j$(nproc) bindeb-pkg
